app-id: org.freedesktop.Sdk.Extension.dotnet
branch: '19.08'
runtime: org.freedesktop.Sdk
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
appstream-compose: false
modules:
  - name: libunwind
    rm-configure: true
    build-options:
      prefix: /usr/lib/sdk/dotnet
    cleanup:
      - '/include'
      - '/pkgconfig'
      - '*.a'
      - '*.la'
      - '*ptrace.so*'
      - '*setjmp.so*'
    sources:
      - type: archive
        url: https://download.savannah.nongnu.org/releases/libunwind/libunwind-1.2.tar.gz
        sha256: 1de38ffbdc88bd694d10081865871cd2bfbb02ad8ef9e1606aee18d65532b992
      - type: script
        commands:
          - 'autoreconf -sif'
        dest-filename: autogen.sh

  - name: dotnet-sdk
    buildsystem: simple
    build-commands:
      - 'mkdir -p /usr/lib/sdk/dotnet/{bin,lib}'
      - 'cp -r * /usr/lib/sdk/dotnet/lib'
      - 'ln -s /usr/lib/sdk/dotnet/lib/dotnet /usr/lib/sdk/dotnet/bin/dotnet'
    sources:
      - type: archive
        only-arches: [x86_64]
        url: https://download.visualstudio.microsoft.com/download/pr/296e116b-30d7-4e1c-8238-ec8c7c4c7b79/43d6cd35d95e38675d472c56a24c3bd0/dotnet-sdk-2.2.103-linux-x64.tar.gz
        sha512: 777ac6dcd0200ba447392e451a1779f0fbfa548bd620a7bba3eebdf35892236c3f10b19ff81d4f64b5bc134923cb47f9cc45ee6b004140e1249582249944db69
      - type: archive
        only-arches: [arm]
        url: https://download.visualstudio.microsoft.com/download/pr/1de01e2e-aa87-4535-af42-8a8a9b4df215/a2fc245f1c26130a2ec22bbf5d0cb3e6/dotnet-sdk-2.2.103-linux-arm.tar.gz
        sha512: a81a1d33cb98fbd3f2c3f724269be74c81e49e2d2aba2b6a1625b66a8f37ed7456c18ddc653a3ef3a09f448b57087172905946f680e4d00fb0603a83e80cf18f
      - type: archive
        only-arches: [aarch64]
        url: https://download.visualstudio.microsoft.com/download/pr/d9e60c5f-af85-4a9e-99ab-26d0cbbd70b7/5fde0e1f8ce2217494e325c9bc09fc0e/dotnet-sdk-2.2.103-linux-arm64.tar.gz
        sha512: 2ed18fcd1ef2bf42aa27446695c7a99d444bde1087e37aa3fd5fd3d626d069e3361effc14ac8f54a6b33b21c288bf4e4177985d51d662a5b257a9c6e22770b03

  - name: scripts
    buildsystem: simple
    build-commands:
      - 'mkdir -p /usr/lib/sdk/dotnet/share/appdata'
      - 'cp enable.sh install.sh install-sdk.sh /usr/lib/sdk/dotnet'
      - 'cp org.freedesktop.Sdk.Extension.dotnet.appdata.xml ${FLATPAK_DEST}/share/appdata'
      - 'mkdir -p /usr/lib/sdk/dotnet/share/appdata'
      - 'appstream-compose --basename=org.freedesktop.Sdk.Extension.dotnet --prefix=${FLATPAK_DEST} --origin=flatpak org.freedesktop.Sdk.Extension.dotnet'
    sources:
      - type: script
        commands:
          - 'mkdir -p /app/dotnet/{bin,lib}'
          - 'cp -L /usr/lib/sdk/dotnet/lib/libunwind{,-coredump,-$FLATPAK_ARCH}.so /app/dotnet/lib'
          - 'cp -r /usr/lib/sdk/dotnet/lib/{dotnet,host,shared} /app/dotnet/lib'
          - 'ln -s /app/dotnet/lib/dotnet /app/dotnet/bin/dotnet'
        dest-filename: install.sh
      - type: script
        commands:
          - '/usr/lib/sdk/dotnet/install.sh'
          - 'cp -r /usr/lib/sdk/dotnet/lib/sdk /app/dotnet/lib'
        dest-filename: install-sdk.sh
      - type: script
        commands:
          - 'export PATH=$PATH:/usr/lib/sdk/dotnet/bin'
          - 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/sdk/dotnet/lib'
          - 'export DOTNET_CLI_TELEMETRY_OPTOUT=true'
          - 'export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true'
        dest-filename: enable.sh
      - type: file
        path: org.freedesktop.Sdk.Extension.dotnet.appdata.xml
